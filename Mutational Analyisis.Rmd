---
title: "Mutational Analysis"
output: html_document
date: "2025-11-20"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
library(ggplot2)
library(dplyr)
library(survival)
library(survminer)
```


#The first thing we want to do before we analyze all of the data is to check and isolate the patients which have all three datasets which is clinical data, mutation data, and expression data. 

```{r}

#First we will read all three data sets 

clinical_data <- read.delim("data_clinical_patient.txt", header = TRUE, stringsAsFactors = FALSE)
mutation_data <- read.delim("data_mutations.txt", header = TRUE, stringsAsFactors = FALSE)
rnaseq_data <- read.csv("RNAseq_LIHC.csv", stringsAsFactors = FALSE)
```


```{r}
extract_id <- function(tcga_codes) {
  tcga_codes <- as.character(tcga_codes)

  ids <- sub("^TCGA-[A-Z0-9]{2}-([A-Z0-9]{4}).*", "\\1", tcga_codes)
  
  return(ids)
}
```


```{r}
extract_id_rnaseq <- function(tcga_codes) {
  tcga_codes <- as.character(tcga_codes)

  ids <- sub("^TCGA.[A-Z0-9]{2}.([A-Z0-9]{4}).*", "\\1", tcga_codes)
  
  return(ids)
}
```


```{r}
clinical_data_cleaned <- clinical_data[-(1:4), ]

clinical_data_patients_id <- extract_id(tcga_codes = clinical_data$X.Patient.Identifier)
clinical_data_patients_id <- clinical_data_patients_id[-(1:4)]

mutation_data_patients_id <- extract_id(tcga_codes = mutation_data$Tumor_Sample_Barcode)

rnaseq_data_cleaned <- rnaseq_data[,-1 ]

rnaseq_data_patients_id <- unique(extract_id_rnaseq(tcga_codes = colnames(rnaseq_data)))

common_patients_id <- clinical_data_patients_id[clinical_data_patients_id %in% mutation_data_patients_id &
clinical_data_patients_id %in% rnaseq_data_patients_id ]
```


```{r}
clinical_full_data <- clinical_data[ which(clinical_data_patients_id  %in% common_patients_id),  ]

mutation_full_data <- mutation_data[ mutation_data_patients_id %in% common_patients_id , ]
```


```{r}
colnames(mutation_data)
```

```{r}
unique(mutation_full_data$Variant_Classification)
```

#waht the fuck 

```{r}

nonsyn_classes <- c(
  "Missense_Mutation",
  "Nonsense_Mutation",
  "Frame_Shift_Del",
  "Frame_Shift_Ins",
  "In_Frame_Del",
  "In_Frame_Ins",
  "Splice_Site",
  "Translation_Start_Site",
  "Nonstop_Mutation"
)

mutation_nonsyn <- mutation_full_data[
  mutation_full_data$Variant_Classification %in% nonsyn_classes, 
]


```

```{r}


if (!"patient_id" %in% colnames(mutation_nonsyn)) {
  mutation_nonsyn$patient_id <- extract_id(mutation_nonsyn$Tumor_Sample_Barcode)
}

gene_patient_counts <- with(mutation_nonsyn,
                            table(patient_id, Hugo_Symbol))


gene_patient_matrix <- ifelse(gene_patient_counts > 0, 1L, 0L)


rownames(gene_patient_matrix) <- rownames(gene_patient_counts)
colnames(gene_patient_matrix) <- colnames(gene_patient_counts)

gene_patient_matrix <- as.data.frame(gene_patient_matrix)
gene_patient_matrix



```


```{r}
# Calculate mutation counts per gene
gene_mutation_counts <- colSums(gene_patient_matrix)

# Sort in decreasing order
gene_mutation_counts_sorted <- sort(gene_mutation_counts, decreasing = TRUE)

# Top 20 genes
top50_genes <- head(gene_mutation_counts_sorted, 50)

top50_genes
```


```{r}
mutation_top50 <- gene_patient_matrix[, top50_genes]
```

```{r}
mutation_mat50 <- as.matrix(mutation_top50)
dist_mat50 <- dist(mutation_mat50, method = "euclidean")
hc_wardD2_top50 <- hclust(dist_mat50, method = "ward.D2")

plot(hc_wardD2_top50)


```

```{r}
k = 4
clusters_top50 <- cutree(hc_wardD2_top50, k = k)

# Output cluster assignment
cluster_assignments <- data.frame(
patient_id = rownames(mutation_mat50),
cluster = factor(clusters_top50)
)
```

```{r}

clinical_with_id <- clinical_full_data %>%
  mutate(patient_id = extract_id(X.Patient.Identifier))


clinical_clustered_top50 <- clinical_with_id %>%
  inner_join(cluster_assignments, by = "patient_id")


print("Merged clinical + cluster data:")
print(head(clinical_clustered_top50))



```
```{r}
library(pheatmap)

common_ids <- intersect(
  rownames(mutation_mat50),
  clinical_clustered_top50$patient_id
)

mutation_mat50_sub <- mutation_mat50[common_ids, ]

clinical_clustered_sub <- clinical_clustered_top50 %>%
  filter(patient_id %in% common_ids)

# ---------------------------------------------------------
# 2. Build annotation dataframe (cluster + sex + age)
# ---------------------------------------------------------

annotation_df <- clinical_clustered_sub %>%
  select(patient_id, cluster, Sex, Diagnosis.Age) %>%
  mutate(
    cluster = factor(cluster),
    Sex = factor(Sex)
  )

rownames(annotation_df) <- annotation_df$patient_id
annotation_df$patient_id <- NULL

# ---------------------------------------------------------
# 3. Heatmap
# ---------------------------------------------------------

pheatmap(
  mutation_mat50_sub,
  annotation_row = annotation_df,
  clustering_method = "ward.D2",
  show_rownames = FALSE,
  show_colnames = TRUE,
  fontsize_col = 8,
  main = "Top 20 Mutated Genes – Mutation Heatmap with Clinical Annotation",
  border_color = NA
)
```

```{r}
surv_df <- clinical_clustered_top50 %>%
  mutate(
    # convert survival status to numeric (1 = event/death, 0 = censored)
    Overall.Survival.Status = as.character(Overall.Survival.Status),
    event = ifelse(grepl("^1", Overall.Survival.Status), 1, 0),

    # convert survival time
    time = as.numeric(Overall.Survival..Months.),

    # cluster must be a factor for KM curves
    cluster = factor(cluster)
  )

# remove rows with NA survival time
surv_df <- surv_df %>% filter(!is.na(time))

# ===============================================================
# 2. Create Surv() object (just like the guide)
# ===============================================================

surv_obj <- Surv(time = surv_df$time, event = surv_df$event)

# ===============================================================
# 3. Fit Kaplan–Meier survival curves for clusters
# ===============================================================

fit <- survfit(surv_obj ~ cluster, data = surv_df)

print(fit)   # optional but mimics guide output

```
```{r}
ggsurvplot(
  fit,
  data = surv_df,
  pval = TRUE,                    # log-rank p-value
  risk.table = TRUE,              # bottom risk table
  risk.table.col = "strata",      # color matches clusters
  conf.int = TRUE,                # confidence intervals
  xlab = "Time (months)",
  ylab = "Survival probability",
  title = "Survival Analysis of Mutation-Based Clusters (Top 20 Genes)",
  legend.title = "Cluster",
  palette = "Dark2"
)
```
```{r}
mutation_full_data$patient_id <- extract_id(mutation_full_data$Tumor_Sample_Barcode)

# Count mutations per patient
mutation_burden <- mutation_full_data %>%
  group_by(patient_id) %>%
  summarize(mutation_count = n()) %>%
  as.data.frame()

mutation_burden
```



```{r}
burden_matrix <- mutation_burden[, "mutation_count", drop = FALSE]
rownames(burden_matrix) <- mutation_burden$patient_id

set.seed(123)
km_burden <- kmeans(burden_matrix, centers = 2, nstart = 25)

burden_clusters <- data.frame(
  patient_id = rownames(burden_matrix),
  burden_cluster = factor(km_burden$cluster)
)
```

```{r}
clinical_with_id <- clinical_full_data %>%
  mutate(patient_id = extract_id(X.Patient.Identifier))

surv_df_burden <- clinical_with_id %>%
  inner_join(burden_clusters, by = "patient_id")
```

```{r}
surv_df_burden <- surv_df_burden %>%
  mutate(
    Overall.Survival.Status = as.character(Overall.Survival.Status),
    event = ifelse(grepl("^1", Overall.Survival.Status), 1, 0),
    time = as.numeric(Overall.Survival..Months.),
    burden_cluster = factor(burden_cluster)
  ) %>%
  filter(!is.na(time))
```

```{r}
surv_obj_burden <- Surv(
  time = surv_df_burden$time,
  event = surv_df_burden$event
)

fit_burden <- survfit(surv_obj_burden ~ burden_cluster, data = surv_df_burden)
fit_burden
```

```{r}
ggsurvplot(
  fit_burden,
  data = surv_df_burden,
  pval = TRUE,
  conf.int = TRUE,
  risk.table = TRUE,
  risk.table.col = "strata",
  xlab = "Time (months)",
  ylab = "Survival probability",
  title = "Survival Analysis Based on Mutation Burden Clusters",
  legend.title = "Mutation Burden Cluster",
  palette = "Dark2"
)
```

